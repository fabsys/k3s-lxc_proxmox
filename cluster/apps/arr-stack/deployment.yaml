---
# ==========================================
# JELLYFIN
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jellyfin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jellyfin
  template:
    metadata:
      labels:
        app: jellyfin
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: jellyfin
          image: docker.io/jellyfin/jellyfin:10.8.13
          ports:
            - containerPort: 8096
          volumeMounts:
            - name: config
              mountPath: /config
            # Montage unique pour l'accès global
            - name: all-media
              mountPath: /data
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: jellyfin-pvc
        # Volume parent qui contient /movies, /shows et /downloads
        - name: all-media
          hostPath:
            path: /mnt/shared_data/movies
            type: Directory

---
# ==========================================
# QBITTORRENT
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qbittorrent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      securityContext:
        fsGroup: 1000
      
      initContainers:
        - name: configure-proxy-and-paths
          image: busybox
          command: ["sh", "-c"]
          args:
            - |
              echo "Configuration qBittorrent (Proxy & Paths)..."
              CONF_FILE="/config/qBittorrent/qBittorrent.conf"
              mkdir -p /config/qBittorrent
              
              if [ ! -f "$CONF_FILE" ]; then
                echo "[Preferences]" > "$CONF_FILE"
              fi

              # Nettoyage des anciennes configs pour éviter les doublons
              sed -i '/Connection\\Proxy/d' "$CONF_FILE"
              sed -i '/Session\\DefaultSavePath/d' "$CONF_FILE"
              
              # Injection Proxy SOCKS5 (Gluetun)
              echo "Connection\Proxy\IP=vpn-service.gluetun" >> "$CONF_FILE"
              echo "Connection\Proxy\Port=8888" >> "$CONF_FILE"
              echo "Connection\Proxy\Type=HTTP" >> "$CONF_FILE"
              echo "Connection\Proxy\LookupDNS=true" >> "$CONF_FILE"
              echo "Connection\Proxy\PeerOnly=false" >> "$CONF_FILE"
              echo "WebUI\LocalHostAuth=false" >> "$CONF_FILE"
              
              # Configuration du chemin de téléchargement unifié
              echo "Session\DefaultSavePath=/data/downloads" >> "$CONF_FILE"
              
              echo "Configuration terminée."
          volumeMounts:
            - name: config
              mountPath: /config

      containers:
        - name: qbittorrent
          image: lscr.io/linuxserver/qbittorrent:5.1.4-libtorrentv1
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "Europe/Paris"
            - name: WEBUI_PORT
              value: "8080"
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /config
            # Montage unique pour l'accès global
            - name: all-media
              mountPath: /data
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: qbittorrent-pvc
        - name: all-media
          hostPath:
            path: /mnt/shared_data/movies
            type: Directory

---
# ==========================================
# RADARR
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: radarr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: radarr
  template:
    metadata:
      labels:
        app: radarr
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: radarr
          image: lscr.io/linuxserver/radarr:5.3.6
          ports:
            - containerPort: 7878
          volumeMounts:
            - name: config
              mountPath: /config
            # Montage unique pour l'accès global
            - name: all-media
              mountPath: /data
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: radarr-pvc
        - name: all-media
          hostPath:
            path: /mnt/shared_data/movies
            type: Directory

---
# ==========================================
# SONARR
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonarr
  template:
    metadata:
      labels:
        app: sonarr
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: sonarr
          image: lscr.io/linuxserver/sonarr:4.0.2
          ports:
            - containerPort: 8989
          volumeMounts:
            - name: config
              mountPath: /config
            # Montage unique pour l'accès global
            - name: all-media
              mountPath: /data
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: sonarr-pvc
        - name: all-media
          hostPath:
            path: /mnt/shared_data/movies
            type: Directory

---
# ==========================================
# PROWLARR
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prowlarr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prowlarr
  template:
    metadata:
      labels:
        app: prowlarr
    spec:
      securityContext:
        fsGroup: 1000
      
      initContainers:
        - name: download-custom-defs
          image: alpine:latest
          # On monte le même volume que Prowlarr pour y écrire le fichier
          volumeMounts:
            - name: config
              mountPath: /config
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "[Init] Démarrage du téléchargement des définitions..."
              
              # Installation de curl (alpine est très léger)
              apk add --no-cache curl
              
              # Variables
              DEST="/config/Definitions/Custom"
              URL="https://gist.githubusercontent.com/Clemv95/8bfded23ef23ec78f6678896f42a2b60/raw/ygg-api-magnet.yml"
              
              # Création du dossier si inexistant
              mkdir -p "$DEST"
              
              # Téléchargement
              echo "[Init] Téléchargement depuis $URL"
              if curl -fsSL "$URL" -o "$DEST/ygg-api-magnet.yml"; then
                  echo "[Init] Téléchargement réussi."
                  
                  # Gestion des permissions (CRITIQUE pour que Prowlarr puisse le lire)
                  # On force l'utilisateur 1000 (celui utilisé par l'image linuxserver)
                  chown 1000:1000 "$DEST/ygg-api-magnet.yml"
                  chmod 644 "$DEST/ygg-api-magnet.yml"
                  
                  echo "[Init] Permissions appliquées."
              else
                  echo "[Init] ERREUR : Impossible de télécharger le fichier."
                  exit 1
              fi

      containers:
        - name: prowlarr
          image: lscr.io/linuxserver/prowlarr:1.13.3
          ports:
            - containerPort: 9696
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: prowlarr-pvc

---
# ==========================================
# JELLYSEERR
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jellyseerr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jellyseerr
  template:
    metadata:
      labels:
        app: jellyseerr
    spec:
      securityContext:
        fsGroup: 1000
      containers:
        - name: jellyseerr
          image: docker.io/fallenbagel/jellyseerr:1.7.0
          ports:
            - containerPort: 5055
          volumeMounts:
            - name: config
              mountPath: /app/config
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: jellyseerr-pvc

---
# ==========================================
# JOAL
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: joal
  labels:
    app: joal
spec:
  replicas: 1
  selector:
    matchLabels:
      app: joal
  template:
    metadata:
      labels:
        app: joal
    spec:
      initContainers:
        - name: init-joal-data
          image: alpine/git
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /data/torrents /data/clients && \
              cp /config/config.json /data/config.json && \
              echo "Copied config.json to /data"
              mkdir -p /data/torrents /data/clients && \
              git clone --depth 1 https://github.com/anthonyraymond/joal.git /tmp/joal && \
              cp -r /tmp/joal/resources/clients/* /data/clients/ && \
              echo "Copied all client files"
          volumeMounts:
            - name: joal-config
              mountPath: /config
            - name: joal-data
              mountPath: /data
      containers:
        - name: joal
          image: anthonyraymond/joal:2.1.36
          args:
            - "--joal-conf=/data"
            - "--spring.main.web-environment=true"
            - "--server.port=$(PORT)"
            - "--joal.ui.path.prefix=$(SECRET_OBFUSCATION_PATH)"
            - "--joal.ui.secret-token=$(SECRET_TOKEN)"
          ports:
            - containerPort: 8080
          env:
            - name: PORT
              value: "8080"
            - name: SECRET_OBFUSCATION_PATH
              value: "joal"
            - name: SECRET_TOKEN
              value: "token"
          volumeMounts:
            - name: joal-data
              mountPath: /data
      volumes:
        - name: joal-config
          configMap:
            name: joal-config
        - name: joal-data
          persistentVolumeClaim:
            claimName: joal-config-pvc